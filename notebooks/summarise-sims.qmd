---
title: Asthma Trial Simulations
author: James Totterdell
date: today
date-format: iso
format: 
    pdf:
        output-file: "asthmatrial-summarise-sims"
        output-ext:  "pdf"
    docx:
        output-file: "asthmatrial-summarise-sims"
        output-ext:  "docx"
execute:
  echo: false
  warning: false
  message: false
prefer-html: true
---

```{r}
#| label: packages
library(asthmasims)
library(data.table)
library(cmdstanr)
library(posterior)
library(extraDistr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(grid)
library(gridExtra)
library(gtable)
library(ggdist)
library(splines2)
library(qs)
library(kableExtra)

theme_set(theme_bw(base_size = 10, base_family = "Palatino"))
```

```{r}
#| label: functions
ord_logit <- function(x) {
    return(qlogis(cumsum(x))[-length(x)])
}

inv_ord_logit <- function(a) {
    cp <- exp(a) / (1 + exp(a))
    p <- diff(c(0, cp, 1))
    return(p)
}

rvar_inv_ord_logit <- function(a) {
    cp <- exp(a) / (1 + exp(a))
    p <- diff(c(rvar(0), cp, rvar(1)))
    return(p)
}

generate_spline_basis <- function(x, y, iknots = 9, quants = FALSE, ...) {
    if (quants) {
        qseq <- seq(0.025, 0.975, length.out = iknots)
        knot_seq <- quantile(y, qseq)
        knots <- floor(knot_seq)
    } else {
        knot_seq <- seq(min(x), max(x), length.out = iknots + 2)
        knots <- floor(knot_seq[2:(iknots + 1)])
    }
    return(iSpline(x, knots = knots, degree = 3, ...))
}

add_facet_labs <- function(p, labelT = "", labelR = "") {
    g <- ggplotGrob(p)
    # Get the positions of the strips in the gtable: t = top, l = left, ...
    posR <- subset(g$layout, grepl("strip-r", name), select = t:r)
    posT <- subset(g$layout, grepl("strip-t", name), select = t:r)
    # Add a new column to the right of current right strips, 
    # and a new row on top of current top strips
    if(nrow(posR) > 0)
        width <- g$widths[max(posR$r)]    # width of current right strips
    if(nrow(posT) > 0)
        height <- g$heights[min(posT$t)]  # height of current top strips
    if(nrow(posR) > 0)
        g <- gtable_add_cols(g, width, max(posR$r))  
    if(nrow(posT) > 0)
        g <- gtable_add_rows(g, height, min(posT$t)-1)
    
    # Construct the new strip grobs
    if(nrow(posR) > 0) {
        stripR <- gTree(name = "Strip_right", children = gList(
        rectGrob(gp = gpar(col = "grey90", fill = "grey90")),
        textGrob(labelR, rot = -90, gp = gpar(fontsize = 8.8, fontface = 'bold', col = "grey10"))))
    }
    if(nrow(posT) > 0) {
        stripT <- gTree(name = "Strip_top", children = gList(
        rectGrob(gp = gpar(col = "grey90", fill = "grey90")),
        textGrob(labelT, gp = gpar(fontsize = 8.8, fontface = 'bold', col = "grey10"))))
    }
    
    # Position the grobs in the gtable
    if(nrow(posR) > 0) {
        g <- gtable_add_grob(g, stripR, t = min(posR$t)+1, 
                        l = max(posR$r) + 1, b = max(posR$b)+1, name = "strip-right")
    }
    if(nrow(posT) > 0) {
        g <- gtable_add_grob(g, stripT, t = min(posT$t), 
                        l = min(posT$l), r = max(posT$r), name = "strip-top")
    }
    
    # Add small gaps between strips
    if(nrow(posR) > 0)
        g <- gtable_add_cols(g, unit(1/5, "line"), max(posR$r))
    if(nrow(posT) > 0)
        g <- gtable_add_rows(g, unit(1/5, "line"), min(posT$t))
    return(g) 
}
```

# Background

## Aim

We want to explore the use of oscillometry used as part of a  pre-emptive strategy in a sub group of kids with poorly controlled asthma, i.e. kids requiring hospitalistion.

## Interventions

1. standard therapy control: do daily oscillometery but this isn't used to guide therapy
2. maximum  therapy control: daily oscillometry but remain on maximum therapy (full dose steroids) 
3. investigational arm: daily oscillometry with trigger for escalation of therapy.

## Randomisation

Target treatment allocation will be 1:1:1 to three arms.

## Primary Outcome

Symptoms as quantified by the number of days in which any symptoms are reported (out of 100 days). 
Symptoms reported daily via smart phone.

Interest lies in the difference in the expected number of days in which any symptoms are reported under each intervention.

## Sample Size

A proposed feasibile sample size is 200 participants.
The following will assess power and trial operating characteristics assuming a sample size of 200 participants.

\clearpage

# Analyses

In the trial we will randomly assign up to $n=200$ participants to one of 3 arms.
For participant $i=1,...,n$ we denote their number of days with symptoms (DWS) as $Y_i\in\{0,1,2,...,100\}$.
We denote by $X\in\{1,2,3\}$ the possible interventions (standard, maximum, investigational respectively).
Our interest is in $\mathbb{E}[Y|X]$ and we aim to decide that the investigational arm is:

- Effective: $\mathbb{E}[Y|X=3] < \mathbb{E}[Y|X=1]$ (investigational arm has lower expected symptom days than standard therapy);
- Non-inferior: $\mathbb{E}[Y|X=3] < \mathbb{E}[Y|X=2] - 10$ (investigational arm has expected symptom days no more than 10 days higher compared to maximum therapy).

The decision criteria are:

- if $\text{Pr}(\mathbb{E}[Y|X=3] < \mathbb{E}[Y|X=1]) > 0.98$ then the investigational aim satisfies effectiveness relative to standard therapy.
- if $\text{Pr}(\mathbb{E}[Y|X=3] - 10 < \mathbb{E}[Y|X=2]) > 0.98$ then the investiational aim satisfies non-inferiority relative to maximal therapy. 

## Modelling

An ordinal cumulative logistic regression model is used to analyse the data. 
The model assumes that the distribution of DWS in the population is smooth (e.g. the examples below) and assumes a proportional effect of treatment on the log cumulative odds ratio.

That is, for $Y^\star = Y + 1$,
$$
\mathbb{P}[Y^\star \leq k] = \text{logit}^{-1}(\alpha_k - x^\mathsf{T}\beta), \quad k=1,..., 100.
$$
for non-decreasing $\alpha$, where
$$
\alpha_k = f(k) = \alpha^\star + \sum_{i=1}^m \theta_{i}I_i(k;d, t) 
$$
for an I-spline basis of degree $d$ with knot locations $t$ with coefficients $\theta_i > 0$.
For the simulations $d=3$ and inner knot locations were set to $\{10, 20, ..., 80, 90\}$ with boundary knots at $\{1, 100\}$.

Priors were,
$$
\begin{aligned}
\beta_j - \beta_l &\sim \text{Normal}(0, \sqrt{2.5}), \text{ for } j\ne l, \text{ subject to } \bar{\beta} = 0 \\
\alpha^\star &\sim \text{Normal}(0, 100) \\
\theta_i &\sim \text{Normal}^+(0, 100)
\end{aligned}
$$

\clearpage

# Examples

## Example 1

The following provides an example simulated trial under an assumed population.
These populations are representative of the kinds of distributions which have been assumed for the trial simulations used to assess operating characteristics.
Suppose that days with symptoms is distributed as in @fig-example1-dist-days-with-symptoms.

The first 100 participants are randomly assigned to one of three interventions. Sample data is shown in @fig-observed-data1.

An ordinal regression model for DWS is inferred from the data which assumes a proportional effect on the conditional odds of having a lower/higher DWS.
The modelled distribution for DWS for each intervention group are in @fig-example1-modelled-dist-dws.
The posterior mean difference in DWS is in @fig-posterior1-difference-in-means.
In this example trial, the investigational arm is found to be effective to standard therapy and non-inferior to maximum therapy.
This trial would have ceased recruitment after 100 participants.

```{r}
#| label: example1-setup
mod <- asthmasims:::compile_cmdstanr_mod("cumulative_logistic_smooth3")
lmod <- asthmasims:::compile_cmdstanr_mod("linear_centred")

pt1 <- ddgamma(0:100, 2, 1 / 15.8)
pt1 <- pt1 / sum(pt1)
alp <- qlogis(cumsum(pt1))[-length(pt1)]

bet <- c(2, 2)
pt2 <- inv_ord_logit(alp + bet[1])
pt3 <- inv_ord_logit(alp + bet[2])

dtru <- tibble(
    x = rep(1:3, each = 101),
    xlab = factor(rep(c("Standard", "Maximum", "Investigational"), each = 101), levels = c("Standard", "Maximum", "Investigational")),
    y = rep(0:100, times = 3),
    p = c(pt1, pt2, pt3)
) |> 
    group_by(x) |> 
    mutate(cp = cumsum(p)) |> 
    ungroup()
dtrum <- dtru |>
    group_by(xlab) |>
    summarise(m = sum(y * p))
```

```{r}
#| label: fig-example1-dist-days-with-symptoms
#| fig-cap: | 
#|      Example distribution of days with any symptoms 
#|      for standard care group and investigational group.
#| fig-height: 2
ggplot(dtru, aes(x = y, y = p)) + 
    geom_line(aes(colour = factor(xlab))) +
    geom_vline(aes(xintercept = dtrum$m[1]), linetype = 2) +
    geom_vline(aes(xintercept = dtrum$m[2]), linetype = 2, colour = "red") +
    scale_colour_manual("Intervention", values = c("black", "red", "red")) +
    labs(x = "Days with symptoms", y = "Proportion") 
```

```{r}
#| label: generate-data1
set.seed(5136)
n <- 33
x <- rep(1:3, each = n)
Xdes <- contr.treatment(3)
y <- asthmasims:::generate_data_x(x, Xdes, alp, bet)
y_weights <- y - 1
Xsp <- generate_spline_basis(1:100, y, 9)
Xsp <- sweep(Xsp, 2, colMeans(Xsp))
p <- aggregate(y, by = list(x), \(z) prop.table(table(factor(z, 0:100))))

dobs <- tibble(
    x = rep(1:3, each = 101),
    xlab = factor(rep(c("Standard", "Maximum", "Investigational"), each = 101), levels = c("Standard", "Maximum", "Investigational")),
    y = rep(0:100, times = 3),
    p = c(p[1, -1], p[2, -1], p[3, -1]),
) |>
    group_by(x) |>
    mutate(cp = cumsum(p)) |>
    ungroup()
```

```{r}
#| label: fig-observed-data1
#| fig-cap: Sample distributions of days with symptoms by treatment group.
#| fig-height: 2
ggplot(dobs, aes(y, cp, colour = xlab, group = x)) +
    geom_step() +
    labs(x = "Days with symptoms", y = "Cumulative proportion", colour = "Intervention") +
    scale_colour_viridis_d()
```

```{r}
#| label: model-data1
lmdat <- list(
    N = n * 3,
    P = 3,
    x = x,
    y = y,
    yc = y - 1,
    beta_sd = 10 / sqrt(2),
    prior = 0
)
mdat <- c(
    lmdat,
    list(
        K = 101,
        P_Isp = ncol(Xsp),
        X_Isp = Xsp,
        y_weights = 0:100,
        alpha_int_sd = 100,
        theta_scale = 10,
        theta_sd = rep(100, ncol(Xsp))
    ))
mdat$beta_sd <- 2.5 / sqrt(2)

snk <- capture.output({
    res <- mod$sample(
        data = mdat, 
        chains = 3, 
        parallel_chains = 3,
        adapt_delta = 0.98)
})

drws <- as_draws_rvars(res$draws(c("alpha", "beta")))
p1 <- rvar_inv_ord_logit(drws$alpha - drws$beta[1])
p2 <- rvar_inv_ord_logit(drws$alpha - drws$beta[2])
p3 <- rvar_inv_ord_logit(drws$alpha - drws$beta[3])
pd <- tibble(
    y = rep(0:100, times = 3),
    p = c(p1, p2, p3),
    x = rep(1:3, each = 101),
    xlab = factor(rep(c("Standard", "Maximum", "Investigational"), each = 101), levels = c("Standard", "Maximum", "Investigational")),
    ptru = c(pt1, pt2, pt3),
    cptru = c(cumsum(pt1), cumsum(pt2), cumsum(pt3))
) |>
    group_by(x, y) |>
    mutate(
        med = median(p), 
        lo = quantile(p, 0.025), 
        hi = quantile(p, 0.975)
    ) |>
    group_by(x) |>
    mutate(cp = cumsum(p)) |>
    ungroup()
pdE <- pd |>
    group_by(x) |>
    summarise(Ey = rvar_sum(y * p)) |>
    ungroup() |>
    mutate(EyDStandard = Ey - Ey[1], EyDMaximum = Ey - Ey[2])
```

```{r}
#| label: fig-example1-modelled-dist-dws
#| fig-cap: | 
#|      Model estimated distribution of days with symptoms by intervention group. Black points indicate posterior median, and coloured rectanges posterior credible intervals of increasing width. Red line indicates true underlying population distribution. Open points indicate observed sample proportions in each outcome level.
#| fig-width: 6
#| fig-height: 6
ggplot(pd, aes(x = y, ydist = p)) +
    facet_wrap( ~ xlab, ncol = 1) +
    stat_interval(size = 1) +
    geom_point(aes(y = median(p)), size = 0.5) +
    geom_line(aes(y = ptru), colour = "red") +
    geom_point(data = dobs, aes(x = y, y = p), shape = 21, colour = "black") +
    labs(
        x = "Days with symptoms", 
        y = "Proportion",  
        colour = "Credible interval") +
    theme(legend.position = "bottom")
```

```{r}
#| label: fig-posterior1-difference-in-means
#| fig-cap: | 
#|      Posterior difference in average number of days 
#|      with symptoms for investigational arm vs standard and maximum.
#| fig-height: 2
pdE |> 
    filter(x == 3) |> 
    pivot_longer(
        EyDStandard:EyDMaximum, 
        names_prefix = "EyD", 
        names_to = "Comparison") |>
    mutate(
        Comparison = paste0("Investigational\nvs\n", Comparison)
    ) |>
    ggplot(data = _, aes(xdist = value, y = Comparison)) +
    stat_halfeye(
      aes(
        fill =
          after_stat(cut_cdf_qi(
            cdf,
            .width = c(.5, .8, .95, 0.99),
            labels = scales::percent_format()
          ))
      ),
      adjust = 1, n = 1001, .width = c(0.5, 0.8, 0.95)
    ) +
    geom_vline(xintercept = 0, linetype = 2) +
    scale_fill_brewer(
      palette = "Reds",
      direction = -1,
      na.translate = FALSE
    ) +
    labs(
      x = "Posterior difference in average days with symptoms",
      fill = "Credible\ninterval"
    ) 
```

\clearpage

## Example 2

Suppose that days with symptoms is distributed as in @fig-example-dist-days-with-symptoms.
In the standard therapy group (black lines) the average number of days with symptoms is 50 and in the maximal group (red lines), the average number of days with symptoms is 30. 
The investigational intervention group is in between these two, and is both effective and non-inferior under this setting.

The first 100 participants are randomly assigned to one of three interventions. 
Sample data is shown in @fig-observed-data.

The modelled distribution for DWS for each intervention group are in @fig-example-modelled-dist-dws.
The posterior mean difference in DWS is in @fig-posterior-difference-in-means.

In this example trial, the investigational arm is found to be effective to standard therapy and non-inferior to maximum therapy.
This trial would have ceased recruitment after 100 participants.

```{r}
#| label: example-setup
mod <- asthmasims:::compile_cmdstanr_mod("cumulative_logistic_smooth3")
lmod <- asthmasims:::compile_cmdstanr_mod("linear_centred")

pt1 <- ddgamma(0:100, 5, 1 / 10.65)
pt1 <- pt1 / sum(pt1)
alp <- qlogis(cumsum(pt1))[-length(pt1)]

bet <- c(2, 1.75)
pt2 <- inv_ord_logit(alp + bet[1])
pt3 <- inv_ord_logit(alp + bet[2])

dtru <- tibble(
    x = rep(1:3, each = 101),
    xlab = factor(rep(c("Standard", "Maximum", "Investigational"), each = 101), levels = c("Standard", "Maximum", "Investigational")),
    y = rep(0:100, times = 3),
    p = c(pt1, pt2, pt3)
) |> 
    group_by(x) |> 
    mutate(cp = cumsum(p)) |> 
    ungroup()
dtrum <- dtru |>
    group_by(xlab) |>
    summarise(m = sum(y * p))
```

```{r}
#| label: fig-example-dist-days-with-symptoms
#| fig-cap: | 
#|      Example distribution of days with any symptoms 
#|      for standard care group and investigational group.
#| fig-height: 2
ggplot(dtru, aes(x = y, y = p)) + 
    geom_line(aes(colour = factor(xlab))) +
    geom_vline(aes(xintercept = dtrum$m[1]), linetype = 2) +
    geom_vline(aes(xintercept = dtrum$m[2]), linetype = 2, colour = "red") +
    scale_colour_manual("Intervention", values = c("black", "red", "blue")) +
    labs(x = "Days with symptoms", y = "Proportion") 
```

```{r}
#| label: generate-data
set.seed(5136)
n <- 33
x <- rep(1:3, each = n)
Xdes <- contr.treatment(3)
y <- asthmasims:::generate_data_x(x, Xdes, alp, bet)
y_weights <- y - 1
Xsp <- generate_spline_basis(1:100, y, 9)
Xsp <- sweep(Xsp, 2, colMeans(Xsp))
p <- aggregate(y, by = list(x), \(z) prop.table(table(factor(z, 0:100))))

dobs <- tibble(
    x = rep(1:3, each = 101),
    xlab = factor(rep(c("Standard", "Maximum", "Investigational"), each = 101), levels = c("Standard", "Maximum", "Investigational")),
    y = rep(0:100, times = 3),
    p = c(p[1, -1], p[2, -1], p[3, -1]),
) |>
    group_by(x) |>
    mutate(cp = cumsum(p)) |>
    ungroup()
```

```{r}
#| label: fig-observed-data
#| fig-cap: Sample distributions of days with symptoms by treatment group.
#| fig-height: 2
ggplot(dobs, aes(y, cp, colour = xlab, group = x)) +
    geom_step() +
    labs(x = "Days with symptoms", y = "Cumulative proportion", colour = "Intervention") +
    scale_colour_viridis_d()
```

```{r}
#| label: model-data
lmdat <- list(
    N = n * 3,
    P = 3,
    x = x,
    y = y,
    yc = y - 1,
    beta_sd = 10 / sqrt(2),
    prior = 0
)
mdat <- c(
    lmdat,
    list(
        K = 101,
        P_Isp = ncol(Xsp),
        X_Isp = Xsp,
        y_weights = 0:100,
        alpha_int_sd = 100,
        theta_scale = 10,
        theta_sd = rep(100, ncol(Xsp))
    ))
mdat$beta_sd <- 2.5 / sqrt(2)

snk <- capture.output({
    res <- mod$sample(
        data = mdat, 
        chains = 3, 
        parallel_chains = 3,
        adapt_delta = 0.98)
    lres <- lmod$sample(
        data = lmdat, 
        chains = 3, 
        parallel_chains = 3)
})

drws <- as_draws_rvars(res$draws(c("alpha", "beta")))
p1 <- rvar_inv_ord_logit(drws$alpha - drws$beta[1])
p2 <- rvar_inv_ord_logit(drws$alpha - drws$beta[2])
p3 <- rvar_inv_ord_logit(drws$alpha - drws$beta[3])
pd <- tibble(
    y = rep(0:100, times = 3),
    p = c(p1, p2, p3),
    x = rep(1:3, each = 101),
    xlab = factor(rep(c("Standard", "Maximum", "Investigational"), each = 101), levels = c("Standard", "Maximum", "Investigational")),
    ptru = c(pt1, pt2, pt3),
    cptru = c(cumsum(pt1), cumsum(pt2), cumsum(pt3))
) |>
    group_by(x, y) |>
    mutate(
        med = median(p), 
        lo = quantile(p, 0.025), 
        hi = quantile(p, 0.975)
    ) |>
    group_by(x) |>
    mutate(cp = cumsum(p)) |>
    ungroup()
pdE <- pd |>
    group_by(x) |>
    summarise(Ey = rvar_sum(y * p)) |>
    ungroup() |>
    mutate(EyDStandard = Ey - Ey[1], EyDMaximum = Ey - Ey[2])
```

```{r}
#| label: fig-example-modelled-dist-dws
#| fig-cap: | 
#|      Model estimated distribution of days with symptoms by intervention group. Black points indicate posterior median, and coloured rectanges posterior credible intervals of increasing width. Red line indicates true underlying population distribution. Open points indicate observed sample proportions in each outcome level.
#| fig-width: 6
#| fig-height: 6
ggplot(pd, aes(x = y, ydist = p)) +
    facet_wrap( ~ xlab, ncol = 1) +
    stat_interval(size = 1) +
    geom_point(aes(y = median(p)), size = 0.5) +
    geom_line(aes(y = ptru), colour = "red") +
    geom_point(data = dobs, aes(x = y, y = p), shape = 21, colour = "black") +
    labs(
        x = "Days with symptoms", 
        y = "Proportion",  
        colour = "Credible interval") +
    theme(legend.position = "bottom")
```

```{r}
#| label: fig-posterior-difference-in-means
#| fig-cap: | 
#|      Posterior difference in average number of days 
#|      with symptoms for investigational arm vs standard and maximum.
#| fig-height: 2
pdE |> 
    filter(x == 3) |> 
    pivot_longer(
        EyDStandard:EyDMaximum, 
        names_prefix = "EyD", 
        names_to = "Comparison") |>
    mutate(
        Comparison = paste0("Investigational\nvs\n", Comparison)
    ) |>
    ggplot(data = _, aes(xdist = value, y = Comparison)) +
    stat_halfeye(
      aes(
        fill =
          after_stat(cut_cdf_qi(
            cdf,
            .width = c(.5, .8, .95, 0.99),
            labels = scales::percent_format()
          ))
      ),
      adjust = 1, n = 1001, .width = c(0.5, 0.8, 0.95)
    ) +
    geom_vline(xintercept = 0, linetype = 2) +
    scale_fill_brewer(
      palette = "Reds",
      direction = -1,
      na.translate = FALSE
    ) +
    labs(
      x = "Posterior difference in average days with symptoms",
      fill = "Credible\ninterval"
    ) 
```

\clearpage

# Operating Characteristics

Simulations were undertaken to assess trial operating characteristics (type I error and power) under a number of assumed populations.

In general:

- operating characteristics under each scenario are based on 500 trial simulations.
- assume that 3 analyses occur at sample sizes of: 100, 150, and 200.
- enrolment rate has been ignored; given that the primary outcome requires at least 100 days of follow-up to be determined, it's conceivable that many more participants have been enrolled into the study by the time 100 participants have completed follow-up. This is not accounted for in the simulations.

The scenarios (in terms of averae days with symptoms) considered are given in @tbl-scenarios-investigated.
For data generation it is also necessary to assume a shape of the distribution in addition to the mean.
These are reported for each scenario.

```{r}
#| label: tbl-scenarios-investigated
#| tbl-cap: Scenarios investigated, numbers are average days with symptoms in each intervention group.
tab <- tribble(
    ~ "Scenario", ~ "Standard", ~ "Maximum", ~ "Investigational",
    1, "30", "10", "10, 15, 20, 25, 30",
    2, "50", "20", "20, 30, 40, 50",
    3, "70", "30", "30, 40, 50, 60, 70"
)
kable(tab, booktabs = TRUE) |>
    kable_styling(latex_options = "HOLD_position", font_size = 9)
```

\clearpage

## Scenario 1

In this scenario, days with symptoms in the population under each intervention were assumed to be as in @fig-dws-dist-scenario1 with differences as in @tbl-effect-size-scenario1.

A summary of the trial power is in @tbl-power-summary-scenario1.
In the no effect scenario, the decision criteria for effectiveness is satisfied in 5% of trials.

Summaries of posterior means and probabilities across trials are shown in @fig-dws-posterior-mean-distribution-scenario2, @fig-dws-posterior-mean-difference-distribution-scenario2, and @fig-event-probabilities-scenario2.


```{r}
#| label: scenario1-files
sc1_files <- list.files(file.path("out"), pattern = "scenario01", full.names = TRUE)
sc1_res <- lapply(sc1_files, \(x) qread(file.path(x)))
sc1_cfg <- rbindlist(lapply(sc1_res, \(x) x[["cfg"]]), idcol = "configuration")
sc1_ctr <- rbindlist(lapply(sc1_res, \(x) x[["contr"]]), idcol = "configuration")
sc1_trial <- rbindlist(lapply(sc1_res, \(x) x[["trial"]]), idcol = "configuration", fill = TRUE)
sc1_alpha <- rbindlist(lapply(sc1_res, \(x) x[["alpha"]]), idcol = "configuration", fill = TRUE)

sc1_trial[, Arm := factor(variable, labels = c("Standard", "Maximum", "Investigational"))]

sc1_ctr[, Comparison := factor(
    variable, 
    labels = c(
        "Investigational\nvs standard", 
        "Investigational\nvs maximum",
        "Maximum\nvs standard")
)]

pd_ctr <- melt(
    sc1_ctr,
    id.vars = c("configuration", "trial", "Comparison", "analysis"), 
    measure.vars = c("pr_ctr_lt0", "pr_ctr_lt10"),
    variable.name = "Event",
    value.name = "Probability"
)[, Event := factor(
    Event, labels = c(
        "Difference < 0", 
        "Difference < 10"))]
pd_ctr2 <- pd_ctr[    (
        Comparison == "Investigational\nvs standard" & 
        Event == "Difference < 0"
    ) | (
        Comparison == "Investigational\nvs maximum" & 
        Event == "Difference < 10"
    ), -5]
pd_ctr2 <- dcast(
    pd_ctr2, 
    configuration + trial + analysis ~ Comparison, 
    value.var = "Probability")
pd_ctr2[, 
    EventJoint := as.numeric(
        `Investigational\nvs standard` > 0.98 & 
        `Investigational\nvs maximum` > 0.98
    ), by = .(configuration, trial, analysis)][, CumEventJoint := as.numeric(cumany(EventJoint)), keyby = .(configuration, trial)]

setkey(pd_ctr, configuration, trial, Comparison, Event, analysis)
pd_ctr[, 
    CumEvent := as.numeric(cumany(Probability > 0.98)), 
    keyby = setdiff(names(pd_ctr), c("analysis", "Probability"))]


pd <- melt(sc1_cfg[, .(
    dws = 0:100,
    Standard = inv_ord_logit(unlist(alpha) + unlist(eta)[1]),
    Maximum = inv_ord_logit(unlist(alpha) + unlist(eta)[2]),
    Investigational = inv_ord_logit(unlist(alpha) + unlist(eta)[3])
), keyby = configuration], 
    id.vars = c("configuration", "dws"), 
    variable.name = "Arm")[, Arm := factor(Arm, levels = c("Standard", "Maximum", "Investigational"))]
pdm <- pd[, .(mu = sum(dws * value), mu_lab = sprintf("%i", round(sum(dws * value), 0))), keyby = .(configuration, Arm)]
pdc <- pdm[, .(
    Comparison = c(
        "Investigational\nvs standard", 
        "Investigational\nvs maximum", 
        "Maximum\nvs standard"),
    mu = c(mu[3] - mu[1], mu[3] - mu[2], mu[2] - mu[1]),
    mu_lab = sprintf("%i", round(c(mu[3] - mu[1], mu[3] - mu[2], mu[2] - mu[1]), 0))
), keyby = configuration]
```

```{r}
#| label: fig-dws-dist-scenario1
#| fig-cap: Assumed distribution of days with symptoms for each arm across scenario configurations.
ggplot(pd, aes(dws, value)) +
    facet_wrap( ~ configuration) +
    geom_line(aes(colour = Arm)) +
    scale_colour_viridis_d() +
    labs(x = "Days with symptoms", y = "Proportion")
```

```{r}
#| label: tbl-effect-size-scenario1
#| tbl-cap: Differences in mean days with symptoms for each configuration. Positive numbers more days with symptoms and negative numbers fewer days with symptoms.
dcast(pdc[, -3], configuration ~ Comparison, value.var = "mu_lab") |>
    kable(booktabs = TRUE) |>
    kable_styling(latex_options = "HOLD_position", font_size = 9)
```

```{r}
#| label: tbl-power-summary-scenario1
#| tbl-cap: Summary of power for decision criteria using a posterior probability threshold of 0.98.
pd_power <- dcast(pd_ctr[, .(
    `Marginal Power` = mean(Probability > 0.98),
    `Cumulative Power` = mean(CumEvent)
), keyby = .(configuration, analysis, Comparison, Event)],
configuration + Comparison + Event ~ analysis, value.var = c("Marginal Power", "Cumulative Power"))
pd_power <- merge(pdc[, -3], pd_power, by = c("configuration", "Comparison"))
pd_power[
    (
        Comparison == "Investigational\nvs standard" & 
        Event == "Difference < 0"
    ) | (
        Comparison == "Investigational\nvs maximum" & 
        Event == "Difference < 10"
    )] |>
    kable(
        booktabs = TRUE,
        digits = 2,
        linesep = "",
        col.names = c("Configuration", "Comparison", "Difference in E[DWS]", "Event", rep(1:3, 2)),
    ) |>
    kable_styling(latex_options = "HOLD_position", font_size = 8) |>
    add_header_above(c(" " = 4, "Marginal power" = 3, "Cumulative power" = 3))
```

```{r}
#| label: tbl-power-summary-2-scenario1
#| tbl-cap: Summary of power for meeting both effectiveness and non-inferiority at a threshold of 0.98 by sequential analysis (1 - 100, 2 - 150, 3 - 200 participants).
pd_power <- pd_ctr2[, .(Power = sprintf("%.2f", mean(CumEventJoint))), 
    keyby = .(configuration, analysis)]
dcast(pd_power, configuration ~ analysis, value.var = "Power") |>
    kable(booktabs = TRUE) |>
    kable_styling(latex_options = "HOLD_position")
```


```{r}
#| label: fig-dws-posterior-mean-distribution-scenario1
#| fig-cap: Distribution of posterior mean for average days with symptoms across trials by configuration (rows) and analysis (columns).
#| fig-width: 4
#| fig-height: 6
p <- ggplot(sc1_trial, aes(Arm, e_mu)) +
    facet_grid(configuration ~ analysis) +
    geom_boxplot() +
    geom_point(data = pdm, aes(y = mu), colour = "red") +
    labs(y = "Posterior mean for average days with symptoms\n(red point is true value)") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
grid.arrange(add_facet_labs(p,  "Analysis", "Configuration"))
```

```{r}
#| label: fig-dws-posterior-mean-difference-distribution-scenario1
#| fig-cap: Distribution of posterior mean for difference in average days with symptoms across trials by configuration (rows) and analysis (columns).
#| fig-width: 5
#| fig-height: 6
p <- ggplot(sc1_ctr, aes(Comparison, e_ctr)) +
    facet_grid(configuration ~ analysis) +
    geom_boxplot() +
    geom_point(data = pdc, aes(y = mu), colour = "red") +
    labs(y = "Posterior mean for difference in average days with symptoms\n(red point is true value)") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
grid.arrange(add_facet_labs(p,  "Analysis", "Configuration"))
```

```{r}
#| label: fig-event-probabilities-scenario1
#| fig-cap: Distribution of event probabilities by comparison, configuration (rows) and analysis (columns).
#| fig-width: 5
#| fig-height: 6
p <- ggplot(pd_ctr, aes(Comparison, Probability)) + 
    facet_grid(configuration ~ analysis) +
    geom_boxplot(aes(colour = Event)) +
    scale_colour_viridis_d(begin = 0.2, end = 0.8) +
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position = "top"
    )
grid.arrange(add_facet_labs(p,  "Analysis", "Configuration"))
```

\clearpage

## Scenario 2

In this scenario, days with symptoms in the population under each intervention were assumed to be as in @fig-dws-dist-scenario2. In all configurations, the average days with symptoms in the standard intervention group was 50 and in the maximum group was 20. The average DWS in the investigational group varied between 50, 40, 30, and 20.

A summary of the trial power is in @tbl-power-summary-scenario2.
In the no effect scenario, the decision criteria for effectiveness is satisfied in 5% of trials.

Summaries of posterior means and probabilities across trials are shown in @fig-dws-posterior-mean-distribution-scenario2, @fig-dws-posterior-mean-difference-distribution-scenario2, and @fig-event-probabilities-scenario2.


```{r}
#| label: scenario2-files
sc2_files <- list.files(file.path("out"), pattern = "scenario02", full.names = TRUE)
sc2_res <- lapply(sc2_files, \(x) qread(file.path(x)))
sc2_cfg <- rbindlist(lapply(sc2_res, \(x) x[["cfg"]]), idcol = "configuration")
sc2_ctr <- rbindlist(lapply(sc2_res, \(x) x[["contr"]]), idcol = "configuration")
sc2_trial <- rbindlist(lapply(sc2_res, \(x) x[["trial"]]), idcol = "configuration", fill = TRUE)
sc2_alpha <- rbindlist(lapply(sc2_res, \(x) x[["alpha"]]), idcol = "configuration", fill = TRUE)

sc2_trial[, Arm := factor(variable, labels = c("Standard", "Maximum", "Investigational"))]

pd <- melt(sc2_cfg[, .(
    dws = 0:100,
    Standard = inv_ord_logit(unlist(alpha) + unlist(eta)[1]),
    Maximum = inv_ord_logit(unlist(alpha) + unlist(eta)[2]),
    Investigational = inv_ord_logit(unlist(alpha) + unlist(eta)[3])
), keyby = configuration], 
    id.vars = c("configuration", "dws"), 
    variable.name = "Arm")[, Arm := factor(Arm, levels = c("Standard", "Maximum", "Investigational"))]
pdm <- pd[, .(mu = sum(dws * value)), keyby = .(configuration, Arm)]
pdc <- pdm[, .(
    Comparison = c(
        "Investigational\nvs standard", 
        "Investigational\nvs maximum", 
        "Maximum\nvs standard"),
    mu = c(mu[3] - mu[1], mu[3] - mu[2], mu[2] - mu[1])
), keyby = configuration]

sc2_ctr[, Comparison := factor(
    variable, 
    labels = c(
        "Investigational\nvs standard", 
        "Investigational\nvs maximum",
        "Maximum\nvs standard")
)]

pd_ctr <- melt(
    sc2_ctr,
    id.vars = c("configuration", "trial", "Comparison", "analysis"), 
    measure.vars = c("pr_ctr_lt0", "pr_ctr_lt10"),
    variable.name = "Event",
    value.name = "Probability"
)[, Event := factor(
    Event, labels = c(
        "Difference < 0", 
        "Difference < 10"))]
pd_ctr2 <- pd_ctr[    (
        Comparison == "Investigational\nvs standard" & 
        Event == "Difference < 0"
    ) | (
        Comparison == "Investigational\nvs maximum" & 
        Event == "Difference < 10"
    ), -5]
pd_ctr2 <- dcast(
    pd_ctr2, 
    configuration + trial + analysis ~ Comparison, 
    value.var = "Probability")
pd_ctr2[, 
    EventJoint := as.numeric(
        `Investigational\nvs standard` > 0.98 & 
        `Investigational\nvs maximum` > 0.98
    ), by = .(configuration, trial, analysis)][, CumEventJoint := as.numeric(cumany(EventJoint)), keyby = .(configuration, trial)]

setkey(pd_ctr, configuration, trial, Comparison, Event, analysis)
pd_ctr[, 
    CumEvent := as.numeric(cumany(Probability > 0.98)), 
    keyby = setdiff(names(pd_ctr), c("analysis", "Probability"))]

pd <- melt(sc2_cfg[, .(
    dws = 0:100,
    Standard = inv_ord_logit(unlist(alpha) + unlist(eta)[1]),
    Maximum = inv_ord_logit(unlist(alpha) + unlist(eta)[2]),
    Investigational = inv_ord_logit(unlist(alpha) + unlist(eta)[3])
), keyby = configuration], 
    id.vars = c("configuration", "dws"), 
    variable.name = "Arm")[, Arm := factor(Arm, levels = c("Standard", "Maximum", "Investigational"))]
pdm <- pd[, .(mu = sum(dws * value), mu_lab = sprintf("%i", round(sum(dws * value), 0))), keyby = .(configuration, Arm)]
pdc <- pdm[, .(
    Comparison = c(
        "Investigational\nvs standard", 
        "Investigational\nvs maximum", 
        "Maximum\nvs standard"),
    mu = c(mu[3] - mu[1], mu[3] - mu[2], mu[2] - mu[1]),
    mu_lab = sprintf("%i", round(c(mu[3] - mu[1], mu[3] - mu[2], mu[2] - mu[1]), 0))
), keyby = configuration]
```

```{r}
#| label: fig-dws-dist-scenario2
#| fig-cap: Assumed distribution of days with symptoms for each arm across scenario configurations.
ggplot(pd, aes(dws, value)) +
    facet_wrap( ~ configuration) +
    geom_line(aes(colour = Arm)) +
    scale_colour_viridis_d() +
    labs(x = "Days with symptoms", y = "Proportion")
```

```{r}
#| label: tbl-effect-size-scenario2
#| tbl-cap: Differences in mean days with symptoms for each configuration. Positive numbers more days with symptoms and negative numbers fewer days with symptoms.
dcast(pdc[, -3], configuration ~ Comparison, value.var = "mu_lab") |>
    kable(booktabs = TRUE) |>
    kable_styling(latex_options = "HOLD_position", font_size = 9)
```

```{r}
#| label: tbl-power-summary-scenario2
#| tbl-cap: Summary of power for decision criteria using a posterior probability threshold of 0.98.
pd_power <- dcast(pd_ctr[, .(
    `Marginal Power` = mean(Probability > 0.98),
    `Cumulative Power` = mean(CumEvent)
), keyby = .(configuration, analysis, Comparison, Event)],
configuration + Comparison + Event ~ analysis, value.var = c("Marginal Power", "Cumulative Power"))
pd_power[
    (
        Comparison == "Investigational\nvs standard" & 
        Event == "Difference < 0"
    ) | (
        Comparison == "Investigational\nvs maximum" & 
        Event == "Difference < 10"
    )] |>
    kable(
        booktabs = TRUE,
        digits = 2,
        linesep = "",
        col.names = c("Configuration", "Comparison", "Event", rep(1:3, 2)),
    ) |>
    kable_styling(latex_options = "HOLD_position", font_size = 8) |>
    add_header_above(c(" " = 3, "Marginal power" = 3, "Cumulative power" = 3))
```

```{r}
#| label: tbl-power-summary-2-scenario2
#| tbl-cap: Summary of power for meeting both effectiveness and non-inferiority at a threshold of 0.98 by sequential analysis (1 - 100, 2 - 150, 3 -200 participants).
pd_power <- pd_ctr2[, .(Power = sprintf("%.2f", mean(CumEventJoint))), 
    keyby = .(configuration, analysis)]
dcast(pd_power, configuration ~ analysis, value.var = "Power") |>
    kable(booktabs = TRUE) |>
    kable_styling(latex_options = "HOLD_position")
```

```{r}
#| label: fig-dws-posterior-mean-distribution-scenario2
#| fig-cap: Distribution of posterior mean for average days with symptoms across trials by configuration (rows) and analysis (columns).
#| fig-width: 4
#| fig-height: 6
p <- ggplot(sc2_trial, aes(Arm, e_mu)) +
    facet_grid(configuration ~ analysis) +
    geom_boxplot() +
    geom_point(data = pdm, aes(y = mu), colour = "red") +
    labs(y = "Posterior mean for average days with symptoms\n(red point is true value)") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
grid.arrange(add_facet_labs(p,  "Analysis", "Configuration"))
```

```{r}
#| label: fig-dws-posterior-mean-difference-distribution-scenario2
#| fig-cap: Distribution of posterior mean for difference in average days with symptoms across trials by configuration (rows) and analysis (columns).
#| fig-width: 5
#| fig-height: 6
p <- ggplot(sc2_ctr, aes(Comparison, e_ctr)) +
    facet_grid(configuration ~ analysis) +
    geom_boxplot() +
    geom_point(data = pdc, aes(y = mu), colour = "red") +
    labs(y = "Posterior mean for difference in average days with symptoms\n(red point is true value)") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
grid.arrange(add_facet_labs(p,  "Analysis", "Configuration"))
```

```{r}
#| label: fig-event-probabilities-scenario2
#| fig-cap: Distribution of event probabilities by comparison, configuration (rows) and analysis (columns).
#| fig-width: 5
#| fig-height: 6
p <- ggplot(pd_ctr, aes(Comparison, Probability)) + 
    facet_grid(configuration ~ analysis) +
    geom_boxplot(aes(colour = Event)) +
    scale_colour_viridis_d(begin = 0.2, end = 0.8) +
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position = "top"
    )
grid.arrange(add_facet_labs(p,  "Analysis", "Configuration"))
```

\clearpage

## Scenario 3

```{r}
#| label: scenario3-files
sc3_files <- list.files(file.path("out"), pattern = "scenario03", full.names = TRUE)
sc3_res <- lapply(sc3_files, \(x) qread(file.path(x)))
sc3_cfg <- rbindlist(lapply(sc3_res, \(x) x[["cfg"]]), idcol = "configuration")
sc3_ctr <- rbindlist(lapply(sc3_res, \(x) x[["contr"]]), idcol = "configuration")
sc3_trial <- rbindlist(lapply(sc3_res, \(x) x[["trial"]]), idcol = "configuration", fill = TRUE)
sc3_alpha <- rbindlist(lapply(sc3_res, \(x) x[["alpha"]]), idcol = "configuration", fill = TRUE)


sc3_trial[, Arm := factor(variable, labels = c("Standard", "Maximum", "Investigational"))]

pd <- melt(sc3_cfg[, .(
    dws = 0:100,
    Standard = inv_ord_logit(unlist(alpha) + unlist(eta)[1]),
    Maximum = inv_ord_logit(unlist(alpha) + unlist(eta)[2]),
    Investigational = inv_ord_logit(unlist(alpha) + unlist(eta)[3])
), keyby = configuration], 
    id.vars = c("configuration", "dws"), 
    variable.name = "Arm")[, Arm := factor(Arm, levels = c("Standard", "Maximum", "Investigational"))]
pdm <- pd[, .(mu = sum(dws * value)), keyby = .(configuration, Arm)]
pdc <- pdm[, .(
    Comparison = c(
        "Investigational\nvs standard", 
        "Investigational\nvs maximum", 
        "Maximum\nvs standard"),
    mu = c(mu[3] - mu[1], mu[3] - mu[2], mu[2] - mu[1])
), keyby = configuration]

sc3_ctr[, Comparison := factor(
    variable, 
    labels = c(
        "Investigational\nvs standard", 
        "Investigational\nvs maximum",
        "Maximum\nvs standard")
)]

pd_ctr <- melt(
    sc3_ctr,
    id.vars = c("configuration", "trial", "Comparison", "analysis"), 
    measure.vars = c("pr_ctr_lt0", "pr_ctr_lt10"),
    variable.name = "Event",
    value.name = "Probability"
)[, Event := factor(
    Event, labels = c(
        "Difference < 0", 
        "Difference < 10"))]
pd_ctr2 <- pd_ctr[    (
        Comparison == "Investigational\nvs standard" & 
        Event == "Difference < 0"
    ) | (
        Comparison == "Investigational\nvs maximum" & 
        Event == "Difference < 10"
    ), -5]
pd_ctr2 <- dcast(
    pd_ctr2, 
    configuration + trial + analysis ~ Comparison, 
    value.var = "Probability")
pd_ctr2[, 
    EventJoint := as.numeric(
        `Investigational\nvs standard` > 0.98 & 
        `Investigational\nvs maximum` > 0.98
    ), by = .(configuration, trial, analysis)][, CumEventJoint := as.numeric(cumany(EventJoint)), keyby = .(configuration, trial)]

setkey(pd_ctr, configuration, trial, Comparison, Event, analysis)
pd_ctr[, 
    CumEvent := as.numeric(cumany(Probability > 0.98)), 
    keyby = setdiff(names(pd_ctr), c("analysis", "Probability"))]

pd <- melt(sc3_cfg[, .(
    dws = 0:100,
    Standard = inv_ord_logit(unlist(alpha) + unlist(eta)[1]),
    Maximum = inv_ord_logit(unlist(alpha) + unlist(eta)[2]),
    Investigational = inv_ord_logit(unlist(alpha) + unlist(eta)[3])
), keyby = configuration], 
    id.vars = c("configuration", "dws"), 
    variable.name = "Arm")[, Arm := factor(Arm, levels = c("Standard", "Maximum", "Investigational"))]
pdm <- pd[, .(mu = sum(dws * value), mu_lab = sprintf("%i", round(sum(dws * value), 0))), keyby = .(configuration, Arm)]
pdc <- pdm[, .(
    Comparison = c(
        "Investigational\nvs standard", 
        "Investigational\nvs maximum", 
        "Maximum\nvs standard"),
    mu = c(mu[3] - mu[1], mu[3] - mu[2], mu[2] - mu[1]),
    mu_lab = sprintf("%i", round(c(mu[3] - mu[1], mu[3] - mu[2], mu[2] - mu[1]), 0))
), keyby = configuration]
```

```{r}
#| label: fig-dws-dist-scenario3
#| fig-cap: Assumed distribution of days with symptoms for each arm across scenario configurations.
ggplot(pd, aes(dws, value)) +
    facet_wrap( ~ configuration) +
    geom_line(aes(colour = Arm)) +
    scale_colour_viridis_d() +
    labs(x = "Days with symptoms", y = "Proportion")
```

```{r}
#| label: tbl-effect-size-scenario3
#| tbl-cap: Differences in mean days with symptoms for each configuration. Positive numbers more days with symptoms and negative numbers fewer days with symptoms.
dcast(pdc[, -3], configuration ~ Comparison, value.var = "mu_lab") |>
    kable(booktabs = TRUE) |>
    kable_styling(latex_options = "HOLD_position", font_size = 9)
```


```{r}
#| label: tbl-power-summary-scenario3
#| tbl-cap: Summary of power for decision criteria using a posterior probability threshold of 0.98.
pd_power <- dcast(pd_ctr[, .(
    `Marginal Power` = mean(Probability > 0.98),
    `Cumulative Power` = mean(CumEvent)
), keyby = .(configuration, analysis, Comparison, Event)],
configuration + Comparison + Event ~ analysis, value.var = c("Marginal Power", "Cumulative Power"))
pd_power[
    (
        Comparison == "Investigational\nvs standard" & 
        Event == "Difference < 0"
    ) | (
        Comparison == "Investigational\nvs maximum" & 
        Event == "Difference < 10"
    )] |>
    kable(
        booktabs = TRUE,
        digits = 2,
        linesep = "",
        col.names = c("Configuration", "Comparison", "Event", rep(1:3, 2)),
    ) |>
    kable_styling(latex_options = "HOLD_position", font_size = 8) |>
    add_header_above(c(" " = 3, "Marginal power" = 3, "Cumulative power" = 3))
```

```{r}
#| label: tbl-power-summary-2-scenario3
#| tbl-cap: Summary of power for meeting both effectiveness and non-inferiority at a threshold of 0.98 by sequential analysis (1 - 100, 2 - 150, 3 - 200 participants).
pd_power <- pd_ctr2[, .(Power = sprintf("%.2f", mean(CumEventJoint))), 
    keyby = .(configuration, analysis)]
dcast(pd_power, configuration ~ analysis, value.var = "Power") |>
    kable(booktabs = TRUE) |>
    kable_styling(latex_options = "HOLD_position")
```

```{r}
#| label: fig-dws-posterior-mean-distribution-scenario3
#| fig-cap: Distribution of posterior mean for average days with symptoms across trials by configuration (rows) and analysis (columns).
#| fig-width: 4
#| fig-height: 6
p <- ggplot(sc3_trial, aes(Arm, e_mu)) +
    facet_grid(configuration ~ analysis) +
    geom_boxplot() +
    geom_point(data = pdm, aes(y = mu), colour = "red") +
    labs(y = "Posterior mean for average days with symptoms\n(red point is true value)") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
grid.arrange(add_facet_labs(p,  "Analysis", "Configuration"))
```

```{r}
#| label: fig-dws-posterior-mean-difference-distribution-scenario3
#| fig-cap: Distribution of posterior mean for difference in average days with symptoms across trials by configuration (rows) and analysis (columns).
#| fig-width: 5
#| fig-height: 6
p <- ggplot(sc3_ctr, aes(Comparison, e_ctr)) +
    facet_grid(configuration ~ analysis) +
    geom_boxplot() +
    geom_point(data = pdc, aes(y = mu), colour = "red") +
    labs(y = "Posterior mean for difference in average days with symptoms\n(red point is true value)") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
grid.arrange(add_facet_labs(p,  "Analysis", "Configuration"))
```

```{r}
#| label: fig-event-probabilities-scenario3
#| fig-cap: Distribution of event probabilities by comparison, configuration (rows) and analysis (columns).
#| fig-width: 5
#| fig-height: 6
p <- ggplot(pd_ctr, aes(Comparison, Probability)) + 
    facet_grid(configuration ~ analysis) +
    geom_boxplot(aes(colour = Event)) +
    scale_colour_viridis_d(begin = 0.2, end = 0.8) +
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position = "top"
    )
grid.arrange(add_facet_labs(p,  "Analysis", "Configuration"))
```


